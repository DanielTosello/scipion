<!DOCTYPE html>
<html lang='es'>
<head>
	<title>Showj</title>
	<meta charset='utf-8'>
	<link rel="icon" type="image/png" href="{{favicon}}" />
	<!-- CSS -->
	<link href="{{css}}" rel="stylesheet" type="text/css">
	<!-- JS -->
	<script src="{{jquery}}" type="text/javascript"></script>
	<script src="{{jquery_waypoints}}" type="text/javascript"></script>
	<script src="{{jquery_hover_intent}}" type="text/javascript"></script>
	
	
	<script type="text/javascript">
	/*  Initialize variable to keep changes*/
	var changes={}
	/*  Dimension of the last image sent by the server*/
	var currentImageDim=parseInt('{{defaultZoom}}')
	/*  If true images are regenerated in the server*/
	var recallServer=false
	/*  Last zoom set properly. In case the new value is too big or small it is set back to the previousZoom*/
	var previousZoom='{{defaultZoom}}'
	/* console.log("fuera")
	alert("fuera") */
	
	$(document).ready(function(){ 
		/* console.log("fuera")
		alert("okokok") */
		
		setImageSize(true)
		initializeZoomEvents();
		initializeColRowModeEvents()
		initializeComboBoxEvents()
		initializeArrowEvents()
		initializeColsRowsEvents()
		initializeCheckboxEvents()
		
		
		/* Avoid enter key submit form */
		$('.menuInputNumber').keypress(function(e) {
		  var code = e.keyCode || e.which; 
		  if (code  == 13) {               
		    e.preventDefault();
		    return false;
		  }
		});
		
	}); 
	</script>
	<script type="text/javascript">
	function initializeImageLoad(){
		$('.tableImages').waypoint(function(direction){
			setImagesSrcAttr($(this))
		}, {
/* 			triggerOnce:true, */
			offset: '150%'
/* 			offset: function() {
		        return $.waypoints('viewportHeight');
		    }
 */		});
	}
	</script>
	<script type="text/javascript">
	function initializeArrowEvents(){
		$(".arrowImage").click(function(){
			if ($(this).closest(".sectionMenu, .subSectionMenu").find(".menuInputNumber").is("[readonly]")==false){
				if ($(this).attr("src").indexOf("Up") != -1){
					$(this).closest(".sectionMenu, .subSectionMenu").find(".menuInputNumber").val(+$(this).closest(".sectionMenu, .subSectionMenu").find(".menuInputNumber").val()+1)
				}
				else{
					$(this).closest(".sectionMenu, .subSectionMenu").find(".menuInputNumber").val(+$(this).closest(".sectionMenu, .subSectionMenu").find(".menuInputNumber").val()-1)
				}
				$(this).closest(".sectionMenu, .subSectionMenu").find(".menuInputNumber").change();
			}	
		});	
	}
	</script>
	<script type="text/javascript">
	function initializeCheckboxEvents(){
		$("#id_mirrorY, #id_transformMatrix, #id_onlyShifts, #id_wrap").click(function(){
			console.log("witole")
			$('form#showjForm').submit();
		})
	}
	</script>
	<script type="text/javascript">
	//Initialize block, metadata, volume and axis to reslice combobox to reload the web when changing
	function initializeComboBoxEvents(){
		$("#id_blockComboBox, #id_labelsToRenderComboBox, #id_volumesToRenderComboBox, #id_resliceComboBox").change(function(){
			$('#id_zoom').val('{{defaultZoom}}')
			$('form#showjForm').submit();
		})
	}
	</script>
	<script type="text/javascript">
	//Initialize events for columns and row mode. 
	//Automatic mode => disable cols & rows textfields
	//Manual mode => enable cols & rows textfields and initialize value
	function initializeColRowModeEvents(){
		$("#colRowMode").click(function(e){
			if ($("#colRowModeImage").attr("src").indexOf("On") != -1){
				/* Change image */
				$("#colRowModeImage").attr("src", $("#colRowModeImage").attr("src").replace("On","Off"))
				
				/* Update hidden variable  */
				$("#id_colRowMode").val("Off");
				
				/* Set textfield to readonly */
				$("#id_cols").attr('readonly', 'True');
				$("#id_rows").attr('readonly', 'True');
				
				/* Allow section div to adjust automatically*/
				$("section").css("width", "");

				e.preventDefault();
			}
			else{
				/* Change image */
				$("#colRowModeImage").attr("src", $("#colRowModeImage").attr("src").replace("Off","On"))
				
				/* Set textfield to editable */
				$("#id_cols").removeAttr('readonly');
				$("#id_rows").removeAttr('readonly');
				
				/* Update hidden variable  */
				$("#id_colRowMode").val("On");
				
				if ($("#id_cols").val()==""){
					initializeColsRows()
				}
				else{
					/* Set section div width automatically */
					updateMainContainerDim($("#id_cols").val())
				}
				e.preventDefault();
			}
		});
	}
	
	//Initialize Columns and Rows textfields. Execute when changing to manual mode
	function initializeColsRows(){
		imgContainerWidth =$(".img_container").width() + (parseInt($(".img_container").css("margin-right")) * 2)
		colVal = Math.floor($("section").width() / (imgContainerWidth + 5))
		$("#id_cols").val(colVal)
		updateGalleryLayout(colVal,0,"id_cols")
	}
	</script>
	<script type="text/javascript">
	//Change gallery layout when cols and rows textfield change
	function initializeColsRowsEvents(){
		$("#id_cols, #id_rows").click(function(){
			updateGalleryLayout($("#id_cols").val(),$("#id_rows").val(), $(this).attr("id"))
		});
		
		$("#id_cols, #id_rows").change(function(){
			alert("por change")
			updateGalleryLayout($("#id_cols").val(),$("#id_rows").val(), $(this).attr("id"))
		});
		$("#id_cols, #id_rows").keyup(function(){
			alert("por keypress")
			updateGalleryLayout($("#id_cols").val(),$("#id_rows").val(), $(this).attr("id"))
		});
	}
	
	function updateGalleryLayout(cols, rows, setElement){
		alert("cols"+cols)
		alert("rows"+rows)
		recalculateColsRows(cols,rows, setElement)
		alert("cols"+cols)
		alert("rows"+rows)
		alert("$(#id_cols).val()"+$("#id_cols").val())
		updateMainContainerDim($("#id_cols").val())
	}
	
	function recalculateColsRows(cols, rows, setElement){
		if (setElement == "id_cols"){
			$("#id_rows").val(Math.ceil($(".img_container").length/cols))
		}
		else{
			$("#id_cols").val(Math.ceil($(".img_container").length/rows))
		}
	}
	function updateMainContainerDim(colVal){
		imgContainerWidth =$(".img_container").width() + (parseInt($(".img_container").css("padding-right")) * 2)
		alert("imgContainerWidth"+imgContainerWidth)
		sectionWidth = colVal * imgContainerWidth
		$("section").width(sectionWidth)
	}
	</script>
	<script type="text/javascript">
		//Initialize events for zoom change
		function initializeZoomEvents(){
			$('#id_zoom').click(function(){
				/* updateImageDimByUrl(); */
				setImageSize(false)
			});
			
			$('#id_zoom').change(function(){
				/* updateImageDimByUrl(); */
				setImageSize(false)
			});
				
	 		$('#id_zoom').keyup(function(e){
	 			var code = e.keyCode || e.which; 
 			  	if (code  == 13) {               
 					 /* updateImageDimByUrl(); */
 					 setImageSize(false)
 			  	}
			});	 
		}
		
		
		function setImageSize(refreshElement){
			/* Gets zoom and image width and height */
			zoom_element=$('#id_zoom')
			
			imageHeight_val = parseInt({{imageDimensions.1}})
			imageWidth_val = parseInt({{imageDimensions.0}})
			
			/* Check if zoom in pixel */
			if (zoom_element.val().indexOf('px')!=-1){
				/*  Get zoom value*/			
				zoom_val=parseInt(zoom_element.val().split('px')[0])
				
				/* Check is image bigger than zoom */
				/* if (zoom_val <  imageWidth_val && zoom_val < imageHeight_val){ */
					/* Calculate zoom in percentage */
					if (imageHeight_val<imageWidth_val){
						tableImages_width=zoom_val
						zoom_val_perc=Math.round((zoom_val/imageWidth_val)*100)
					} 
					else{
						console.log(imageWidth_val,imageHeight_val)
						tableImages_width=Math.round(zoom_val*(imageWidth_val/imageHeight_val))+1
						zoom_val_perc=Math.round((zoom_val/imageHeight_val)*100)
					}
					
				/* } */
				
			}
			else{
				zoom_val_perc=zoom_element.val()
				if (imageHeight_val<imageWidth_val){
					zoom_val_pixel=Math.round((zoom_val_perc*imageWidth_val)/100)
					tableImages_width=zoom_val_pixel
				} 
				else{
					zoom_val_pixel=Math.round((zoom_val_perc*imageHeight_val)/100)
					tableImages_width=zoom_val_pixel
				}
			}
			
			/*  CHECK ZOOM VALUE IS A NUMBER BETWEEN MAX AND MIN*/
			/* NAPA DE LUXE: El max y el min deberia ser parametrizable  */
			if (isNaN(tableImages_width) || tableImages_width>512 || tableImages_width<30){
				alert('Incorrect table width: '+tableImages_width)
				zoom_element.val(previousZoom)
				setImageSize(true)
				return;
			}
			else{
				previousZoom=tableImages_width+"px"
			}
			
			if (refreshElement==true){
				zoom_element.val(zoom_val_perc)
			}
			
			if (tableImages_width>currentImageDim*1.2 || tableImages_width<currentImageDim*0.8){
				recallServer=true
				currentImageDim=tableImages_width
			}	
			else{
				recallServer=false
			}
			
			d = new Date();
			$(".tableImages").each(function(){
			   	var newSrc = "";
			   	if ($(this).data("real_src").indexOf("&dim") != -1){
			   		newSrc = $(this).data("real_src").substring(0,$(this).data("real_src").indexOf("&dim"));
			   	}
			   	else{
					newSrc = $(this).data("real_src");   
			   	}
			   	$(this).attr("height",tableImages_width)
			   	$(this).attr("width",tableImages_width)
		   	
		   		realSrc = newSrc.concat("&dim="+tableImages_width).concat("&"+d.getTime())
				$(this).data("real_src", realSrc);
			   	
 		   		 	
	
		   })
		   
		   /* If images with new dimensions need to be generated in the server, waypoints jquery script manages it */
		   if (recallServer){
				$.waypoints('destroy')
				initializeImageLoad()
		   }
		}

	</script>
	<script type="text/javascript">
	function setImagesSrcAttr(element){
		if (element.data('real_src') != element.attr("src")){
			element.attr(
				"src",
				element.data('real_src').concat($("#id_mirrorY").is(':checked')?"&mirrorY":"").concat($("#id_transformMatrix").is(':checked')?"&transformMatrix":"").concat($("#id_onlyShifts").is(':checked')?"&onlyShifts":"").concat($("#id_wrap").is(':checked')?"&wrap":"")
				)
		}
	}
	</script>
	<script type="text/javascript">
	//Save table change in metadata
	function saveShowjTable(){
		if ($("#saveButton").hasClass("saveOn")){
			$.ajax({
				type : "POST",
				url : "/save_showj_table/",
				dataType : "json",
				data : {
					changes: JSON.stringify(changes),
					csrfmiddlewaretoken: '{{ csrf_token }}'
				}, 
				success : function(json) {
					message = json.message;
					if (message == 'Ok'){
						changes={}
						$("#saveButton").toggleClass("saveOn").toggleClass("saveOff")
					}
					else{
						alert(message)
					}
				}
			});
		}
	}
	</script>
	{% block head %}  {% endblock %}
</head>
<body>
	<header>
	<div style="width:50%">
		<!-- <div style="float:left;" id="logoDiv"> -->
		<a href="#" style="margin:2px 0px 0px 8px"><img class="logo" src="{{logo}}" alt="Scipion logo" style="max-height:60px; "></a>
		<!-- </div> -->
		
		<div style="padding:16px 0px 0px 15px;text-align:center;display:inline;">
		<span class="project_name" style="font-size:1.8em; ">Xmipp Showj Web</span>
		</div>
		
		<div style="padding:16px 0px 0px 15px;text-align:center;display:inline;">
		<a href="http://localhost:8081/hello/taka" style="margin:2px 0px 0px 8px" target="_blank">Testing SSH</a>
		</div> 
	</div>
	
	<div style="padding-top:60px;text-align:right;width:45%;display:inline;" >
		<a href="/project_content/?projectName={{projectName}}">Back to project</a>
	</div>
	</header>
<!-- 	<nav>  Top Menu
		<ul>
			<li>File</li>
			<li>Display</li>
			<li>Help</li>
		</ul>
	</nav> -->
	<div id="main_section">
		<aside id="side_news"> <!-- Main Menu -->

			<form id="showjForm" action="/showj/" method="post"> {% csrf_token %}
				<div id="modeContainer" class="sectionMenu">
					<input type="submit" value="table" name="select_mode" onclick="document.forms['showjForm'].id_mode.value='table';" class="submitButton
					 {% if form.mode.value == 'gallery' or form.mode.value == 'column' %}
					  tableOff
					 {% endif %}
					 {% if form.mode.value == 'table' %}
					 tableOn
					 {% endif %}	
					  " 
					  {% if form.mode.value == 'column' %}
					  disabled
					  {% endif %}
					  />
					<input type="submit" value="gallery" name="select_mode" onclick="document.forms['showjForm'].id_mode.value='gallery';" class="submitButton
					{% if form.mode.value == 'gallery' %}
					  galleryOn
					 {% endif %}
					 {% if form.mode.value == 'table' or form.mode.value == 'column'  %}
					 galleryOff
					 {% endif %}
					 "
					 {% if form.mode.value == 'column' %}
					  disabled
					 {% endif %}
					 />
				</div>
				
				<div id="zoomContainer" class="sectionMenu">
					<img src="/resources/showj/zoom.png" class="menuIcon">
					{{ form.zoom }}
					
					<div id="arrowContainer" class="arrowSectionMenu">
						<img src="/resources/showj/arrowUp.png" class="arrowImage">
						<img src="/resources/showj/arrowDown.png" class="arrowImage">
					</div>
					<!-- <input type="number" class="menuInputNumber" id="zoom" value="150" min="10"> -->
				</div>
				
				<div id="gotoContainer" class="sectionMenu">
					<img src="/resources/showj/goto.png" class="menuIcon">
					{{ form.goto }}
					
					<div id="arrowContainer" class="arrowSectionMenu">
						<img src="/resources/showj/arrowUp.png" class="arrowImage">
						<img src="/resources/showj/arrowDown.png" class="arrowImage">
					</div>
					<!-- <input type="number" class="menuInputNumber" id="goto" value="1" max="{{metadata.objects|length}}" min="1"> -->
				</div>
				
				<div class="sectionMenu">
					<img src="/resources/showj/separator.png" class="menuIcon">
				</div>	
				
				{% if form.mode.value == 'gallery' %}
				<div id="colRowContainer" class="sectionMenu">
					<button id="colRowMode"> 
						<img src="/resources/showj/colRowMode{{form.colRowMode.value}}.png" id="colRowModeImage" />
					</button>
					
					<div class="subSectionMenu">
						<span class="textMenu">{{ form.cols.label_tag }}</span>
						{{ form.cols }}
						
						<div id="arrowContainer" class="arrowSectionMenu">
							<img src="/resources/showj/arrowUp.png" class="arrowImage">
							<img src="/resources/showj/arrowDown.png" class="arrowImage">
						</div>
						<!-- <input type="number" class="menuInputNumber" id="cols" value="" min="1" max="{{metadata.objects|length}}" disabled> -->
					</div>
					<div class="subSectionMenu">
						<span class="textMenu">{{ form.rows.label_tag }}</span>
						{{ form.rows }}
						
						<div id="arrowContainer" class="arrowSectionMenu">
							<img src="/resources/showj/arrowUp.png" class="arrowImage">
							<img src="/resources/showj/arrowDown.png" class="arrowImage">
						</div>
						<!-- <input type="number" class="menuInputNumber" id="rows" value="" min="1" max="{{metadata.objects|length}}" disabled> -->
					</div>
				</div>
				{% endif %}
				
				<div class="sectionMenu">
					<img src="/resources/showj/separator.png" class="menuIcon">
				</div>
		
				<div id="blockSelectorContainer" class="sectionMenu">
					<span class="textMenu"> {{ form.blockComboBox.label_tag }} </span>
					{{ form.blockComboBox }} 
				</div>
				
				<div id="metadataSelectorContainer" class="sectionMenu">
					<span class="textMenu">
					{% if not form.labelsToRenderComboBox.is_hidden %}
					{{ form.labelsToRenderComboBox.label_tag }}
					{% endif %}
					</span>
					{{ form.labelsToRenderComboBox }}
				</div>
				
				<div id="volumeSelectorContainer" class="sectionMenu">
					<span class="textMenu">
					{% if not form.volumesToRenderComboBox.is_hidden %}
					{{ form.volumesToRenderComboBox.label_tag }}
					{% endif %}
					</span>
					{{ form.volumesToRenderComboBox }}
				</div>
				
				
				<div id="mirrorContainer" class="sectionMenu">
					<span class="textMenu"> {{ form.mirrorY.label_tag }} </span>
					{{ form.mirrorY }} 
				</div>
				
				<div id="resliceSelectorContainer" class="sectionMenu">
					<span class="textMenu">
					{% if not form.resliceComboBox.is_hidden %}
					{{ form.resliceComboBox.label_tag }}
					{% endif %}
					</span>
					{{ form.resliceComboBox }}
				</div>
		
				<div class="sectionMenu">
					<img src="/resources/showj/separator.png" class="menuIcon">
				</div>
				
				<div id="saveContainer" class="sectionMenu">
					<button id="saveButton" onclick="saveShowjTable(); return false;" class="saveOff">
						<!-- <img src="/resources/showj/saveOff.png" id="saveButtonImage" /> -->
					</button>
				</div> 
				 
				{% block content_menu %}	{% endblock %}
				 
				{% for hidden in form.hidden_fields %}
			    {{ hidden }}
			    {% endfor %} 
				 
			</form>
		</aside>
		
		<section> <!--  Es donde va la informacion princiapl -->
		

		
		{% block content_view %}	{% endblock %}	
		<!-- Hidden menu for multiple selection tool -->
		<div class="multipleSelectionToolContainer" id="multipleSelectionTool">
			{% if dataset.getTable.hasEnabledColumn %}
			<div class="multipleSelectionToolItem" onclick="multipleEnableDisableImage('enable')">Enable</div>
			<div class="multipleSelectionToolItem" onclick="multipleEnableDisableImage('disable')">Disable</div>
			{% endif %}
			<div class="multipleSelectionToolItem" onclick="multipleSelect('all')">Select All</div>
			<div class="multipleSelectionToolItem" onclick="multipleSelect('from')">Select From Here</div>
			<div class="multipleSelectionToolItem" onclick="multipleSelect('to')">Select To Here</div>
		</div>	

			
		</section>
	</div>
	

</body>
</html>
