{% extends 'showj_base.html' %} 
{% block head %}
<!-- CSS -->
<link type="text/css" href="/static/css/jquery-ui_smoothness.css" rel="stylesheet" />
<!-- JS -->
<script type="text/javascript" src="{{jquery_datatable}}"></script>
<script type="text/javascript" src="{{jquerydataTables_colreorder}}"></script>
<script type="text/javascript" src="{{jeditable}}"></script>
<script type="text/javascript" src="{{jquery_ui}}"></script>
<!-- <script type="text/javascript" src="{{jquery_tabletools}}"></script> -->



<script type="text/javascript">
var oTable;
var giRedraw = false;

$(document).ready(function() {
	initializeSelectionRowEvent2() 
	initializeGoToEvent()
	initializeTableWidth()
	
	
	/* $("#form").submit(function() {
		var sData = $('input', oTable.fnGetNodes()).serialize();
		alert( "The following data would have been submitted to the server: \n\n"+sData );
		return false;
	} ) */
	
	/* Add a click handler for the delete row */
	/* $('#delete').click( function() {
		var anSelected = fnGetSelected( oTable );
		oTable.fnDeleteRow( anSelected[0] );
	} ); */
	
	
	/* Init the table */
	oTable = $('#data_table').dataTable(
				{
			        "bPaginate": true,
			        "bLengthChange": true,
			        "bFilter": true,
			        "bSort": true,
			        "bInfo": true,
			        "bAutoWidth": true,
			        "sDom": 'Rlfrtip', 
			        /* "sDom": 'T<"clear">lfrtip', */
			        /*"sScrollX": "100%",
			        "sScrollXInner": "110%",
			        "bScrollCollapse": true,*/ 
			        "oColReorder": {
		    			"aiOrder": {{metadata.tableLayoutConfiguration.colsOrder}}
		    		}, 
		    		
		    		"bProcessing": true,
/* 		            "bServerSide": true, */
/* 		            "sAjaxSource": "/get_table/", */
		            
		            "fnServerParams": function ( aoData ) {
		                aoData.push( {
		                	"path": "{{inputParameters.path}}",
		                	"block": "{{inputParameters.block}}",
		                	"allowRender": "{{inputParameters.allowRender}}",
		                	"imageDim": "{{inputParameters.imageDim}}"
		                		} );
		            },
		            "bDeferRender": true,
		    		/* "bRetrieve": true */
/* 		    		"aaData":{% autoescape off %}
		             {{ metadata.objects }}
		            		{% endautoescape %}
		    			, */
		    		"aaData": generateDataForTable(),	
			        "aoColumns": [
			        		{% for label, typeOfColumn in metadata.tableLayoutConfiguration.labels_typeOfColumns %}
				        		{ 
				        			{% if typeOfColumn == "text" %}
				        			"sClass": "editable",
				        			{% endif %}
				        			"sTitle": '{{label}}'
				        		},
			    			{% endfor %}				
			        ] ,
		            "bJQueryUI": true,
		    		"sPaginationType": "full_numbers"
/*  		    		"oTableTools": {
		    			"sRowSelect": "single",
		    			"aButtons": [ "select_all", "select_none" ]
		    		}  */
					
			    }		
			);
	
	/* setTableEditable() */ 
	
} );



function setTableEditable(){
	$('.editable', oTable.fnGetNodes()).editable(
			/* '../examples_support/editable_ajax.php', */
			function(value, settings) { 
			     console.log(this);
			     console.log(value);
			     console.log(settings);
			     return(value);
			  },
			{
			"callback": function( sValue, y ) {
				var aPos = oTable.fnGetPosition( this );
				oTable.fnUpdate( sValue, aPos[0], aPos[1] );
			},
			"submitdata": function ( value, settings ) {
				return {
					"row_id": this.parentNode.getAttribute('id'),
					"column": oTable.fnGetPosition( this )[2]
				};
			},
			"height": "14px"
		} );
}

function generateDataForTable(){
	dataForTable = new Array();
	{% for obj in metadata.objects %}
		dataRowForTable = new Array()
		{% for value in obj.values %}
			{% if value.typeOfColumn == "image" %} 
				dataRowForTable.push("<img class=\"tableImages\" id=\"{{value.label}}___{{forloop.parentloop.counter0}}\" src=\"/get_image/?image={{value.imgValue}}\"/>")
		   	{% elif value.typeOfColumn == "checkbox" and value.strValue == '1' %}
				dataRowForTable.push("<input type=\"checkbox\" onclick=\"valueChange(this);\" id=\"{{value.label}}___{{forloop.parentloop.counter0}}\" checked>")
			{% elif value.typeOfColumn == "checkbox" and value.strValue != '1' %}
				dataRowForTable.push("<input type=\"checkbox\" onclick=\"valueChange(this);\" id=\"{{value.label}}___{{forloop.parentloop.counter0}}\">")
		   	{% else %}
				dataRowForTable.push("{{value.strValue}}")
		   	{% endif %}	
		{% endfor %}
		/* dataRowForTable.push("DT_RowId: \"{{forloop.counter0}}\"") */
		dataForTable.push(dataRowForTable)
	{% endfor %}
	return dataForTable;
}

function valueChange(element){
	element_value = ""
	if ($(element).is("input:checkbox")){
		element_value = $(element).is(":checked")
	}
	else{
		element_value = $(element).val()
	}
	
	saveShowjTable($(element).attr("id"), element_value)
	
	
}

function initializeTableWidth(){
	var tableWidth = $("section").width()
	if ($("#table_container").width()>tableWidth){
		$("#table_container").width(tableWidth);
	}	
}

function initializeGoToEvent(){
	$('#id_goto').click(function(){
		updateRowSelection();	
	});
	
	$('#id_goto').change(function(){
		updateRowSelection();
	});
}
function updateRowSelection(){
	var nodes = oTable.fnGetNodes();
    for (var i=0; i<nodes.length; i++){
		if (nodes[i].id == $("#id_goto").val()){
			/* Falta arreglar. El click se ejecuta sobre el tbody no el tr
			http://datatables.net/extras/tabletools/api#fnSelect */
			$("#"+nodes[i].id).children("td").first().click();
		}    	
        
    }
}

var lastChecked;
function initializeSelectionRowEvent2(){
	$('#data_table').on("click","tr", function(event) {
        alert("okokokok")
	    if(!lastChecked) {
	    	alert("tolastchecked")
	        lastChecked = this;
	    }
	     
	    if(event.shiftKey) {
	        var start = $('#data_table tbody tr').index(this);
	        var end = $('#data_table tbody tr').index(lastChecked);
	 
	        for(i=Math.min(start,end);i<=Math.max(start,end);i++) {
	            if (!$('#data_table tbody tr').eq(i).hasClass('row_selected')){
	                $('#data_table tbody tr').eq(i).addClass("row_selected");
	            }
	        }
	         
	        // Clear browser text selection mask
	        if (window.getSelection) {
	            if (window.getSelection().empty) {  // Chrome
	                window.getSelection().empty();
	            } else if (window.getSelection().removeAllRanges) {  // Firefox
	                window.getSelection().removeAllRanges();
	            }
	        } else if (document.selection) {  // IE?
	            document.selection.empty();
	        }
	    } else if ((event.metaKey || event.ctrlKey)){
	        $(this).toggleClass('row_selected');
	    } else {
	    	/* $(lastChecked).removeClass('row_selected'); */
	    	
	    	$('tr').each(function (){
				$(this).removeClass('row_selected');
			});
	        $(this).addClass('row_selected');  
	    }
	    
	    alert($(this).prevAll().length)
	     
	    lastChecked = this;
	});
}

function initializeSelectionRowEvent(){
	/* Add a click handler to the rows - this could be used as a callback */
	$("#data_table").click(function(event) {
		alert('heyhey')
		$(oTable.fnSettings().aoData).each(function (){
			$(this.nTr).removeClass('row_selected');
		});
		$(event.target.parentNode).addClass('row_selected');

		/* Refresh value on got field  */
		selectedRows = fnGetSelected(oTable)

		alert(selectedRows[0].id)
		
		if (selectedRows.length == 1) {
			$("#id_goto").val(selectedRows[0].id)
		}
		else{
			$("#id_goto").val(0)
		}
	});

}

/* Get the rows which are currently selected */
function fnGetSelected(oTableLocal)
{
	var aReturn = new Array();
	var aTrs = oTableLocal.fnGetNodes();
	
	for ( var i=0 ; i<aTrs.length ; i++ )
	{
		if ( $(aTrs[i]).hasClass('row_selected') )
		{
			aReturn.push( aTrs[i] );
		}
	}
	return aReturn;
}
</script>
{% endblock %}

{% block content_menu %}{% endblock %}
			
{% block content_view %}
	
<div id="table_container" style="overflow-x:scroll">
		<table cellspacing="0" id="data_table" width="100%">
		</table>
</div>
			
{% endblock %}
